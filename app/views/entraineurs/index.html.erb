<% selected_year = params[:annee].presence || Date.today.year %>
<% selected_month = params[:mois].presence || Date.today.month %>

<p class="text-success"><%= notice %></p>

<% content_for :title, "Entraîneurs" %>

<h1 class="mb-4">Entraîneurs</h1>

<div class="mb-3 d-flex align-items-center">
  <label for="monthPicker2" class="form-label me-2">Mois :&nbsp;</label>
  <input 
    type="month" 
    id="monthPicker2" 
    class="form-control"
    style="width: 20%;" 
    value="<%= "#{selected_year}-#{selected_month.to_s.rjust(2, '0')}" %>" 
    onchange="redirectToMonth(this)">&nbsp;<%= link_to "Ce mois", entraineurs_path, class: "btn btn-secondary" %>
</div>

<div class="mb-3">
  <%= link_to 'Tous', request.path + "?" + request.query_parameters.except(:filter).to_query, class: 'btn btn-primary' %>
  <%= link_to 'Non payés', request.path + "?" + request.query_parameters.merge(filter: 'nonpayes').to_query, class: 'btn btn-danger' %>
</div>

<table class="table table-striped table-bordered datatable">
  <thead class="thead-light">
    <tr>
      <th>ID</th>
      <th>Nom de l'entraîneur</th>
      <th>Téléphone</th>
      <th>Salaire (Dt)</th>
      <th>État du salaire (<%= "#{Date::MONTHNAMES[selected_month.to_i]} #{selected_year}" %>)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <% @entraineurs.each do |entraineur| %>
      <% salaire_paye = entraineur.salaires.find { |s| s.annee == selected_year.to_i && s.mois == selected_month.to_i } %>
      <% if !(params[:filter].presence && salaire_paye)%>
      <tr id="<%= dom_id entraineur %>">
        <td><%= entraineur.id %></td>
        <td><%= "#{entraineur.prénom} #{entraineur.nom}" %></td>
        <td><%= entraineur.téléphone %></td>
        <td><%= number_to_currency(entraineur.salaire, unit: "", delimiter: " ") %></td>
        <td>
          <% if salaire_paye %>
            <span class="badge bg-success" style="color:white">Payé : <%= "#{salaire_paye.salaire} Dt" %></span>
          <% else %>
            <span class="badge bg-danger" style="color:white">Non payé</span>
          <% end %>
        </td>
        <td>
          <%= link_to "Modifier", edit_entraineur_path(entraineur), class: "btn btn-primary btn-sm me-2" %>
          <%= button_to "Supprimer", entraineur, method: :delete, data: { confirm: "Êtes-vous sûr ?" }, class: "btn btn-danger btn-sm" %>
        </td>
      </tr>
    <% end %>
    <% end %>
  </tbody>
</table>

<p>
  <%= link_to "Nouvel entraîneur", new_entraineur_path, class: "btn btn-success" %>
  <%= link_to "Ajouter salaire", new_salaire_path, class: "btn btn-primary" %>
  <%= link_to "Journal des salaires", salaires_path, class: "btn btn-secondary", style: "float:right" %>
</p>

<script>
  function redirectToMonth(input) {
    const [year, month] = input.value.split('-');
    const url = new URL(window.location.href);
    url.searchParams.delete('filter');
    url.searchParams.set('annee', year);
    url.searchParams.set('mois', month);
    window.location.href = url.toString();
  }
</script>
